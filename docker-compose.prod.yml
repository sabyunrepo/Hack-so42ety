services:
  # ==================== PostgreSQL (Production Settings) ====================
  postgres:
    environment:
      # 프로덕션 환경 변수는 .env 파일에서 관리
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      # 프로덕션에서는 외부 포트 노출 제거 (내부 네트워크만 사용)
      - "127.0.0.1:5432:5432"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== Redis (Production Settings) ====================
  redis:
    ports:
      # 프로덕션에서는 외부 포트 노출 제거
      - "127.0.0.1:6379:6379"
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== Backend (Production Settings) ====================
  backend:
    environment:
      - APP_ENV=prod
      - DEBUG=false
      - LOG_LEVEL=INFO
      # Redis 비밀번호 추가 (설정된 경우)
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      # Remove source code mount for production (rely on image)
      # Only mount data
      - app-data:/app/data
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ==================== Frontend Builder (Production) ====================
  frontend-builder:
    build:
      context: ./frontend
      dockerfile: ../docker/frontend/Dockerfile
      target: builder
    image: moriai-frontend:prod
    container_name: moriai-frontend-builder-prod
    volumes:
      - frontend-dist:/app/dist
    command: sh -c "npm run build && echo 'Frontend build completed'"
    restart: "no"
    networks:
      - moriai-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # ==================== Nginx (Production Settings) ====================
  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
      args:
        APP_ENV: prod
    image: moriai-nginx:prod
    volumes:
      - app-data:/app/data:ro
      # Mount frontend build output
      - frontend-dist:/usr/share/nginx/html:ro
    depends_on:
      - backend
      - frontend-builder
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # ==================== Cloudflare Tunnel ====================
  cloudflared:
    profiles:
      - production
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
