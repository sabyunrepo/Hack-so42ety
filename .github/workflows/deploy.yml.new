name: ðŸš€ Trigger Deployment (Watchtower)

on:
  workflow_run:
    workflows: ["ðŸ³ Build and Push Docker Images"]
    types: [completed]
    branches: [dev, main]

jobs:
  # ==================== Dev í™˜ê²½ ë°°í¬ íŠ¸ë¦¬ê±° ====================
  trigger-dev:
    name: ðŸ“¢ Trigger Dev Watchtower
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'

    steps:
      - name: ðŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.DEV_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh-keyscan -p 23 -T 10 14.36.34.122 >> ~/.ssh/known_hosts 2>/dev/null || true

          cat > ~/.ssh/config << 'EOF'
          Host 14.36.34.122
            Port 23
            StrictHostKeyChecking accept-new
            UserKnownHostsFile ~/.ssh/known_hosts
            ConnectTimeout 30
          EOF
          chmod 600 ~/.ssh/config

      - name: ðŸ“¢ Trigger Watchtower Update
        env:
          DEV_HOST: "14.36.34.122"
          DEV_PORT: "23"
          DEV_USER: "${{ secrets.DEV_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ðŸ“¢ Triggering Watchtower on Dev server..."

          ssh -p ${DEV_PORT} ${DEV_USER}@${DEV_HOST} << 'ENDSSH'
            echo "ðŸ”„ Running Watchtower update..."
            docker exec moriai-watchtower /watchtower --run-once || echo "âš ï¸ Watchtower not running yet"

            echo "â³ Waiting for update to complete (30s)..."
            sleep 30

            echo "ðŸ“Š Checking container status..."
            cd ~/Hack-so42ety
            docker compose -f docker-compose.yml ps
          ENDSSH

      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ¥ Checking service health..."
          sleep 10
          curl -f http://14.36.34.122/api/health || echo "âš ï¸ Health check failed"

      - name: ðŸ“ Deployment Summary
        run: |
          echo "### ðŸŽ‰ Dev Deployment Triggered!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: 14.36.34.122:23" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Watchtower Auto-Update" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY

  # ==================== Production í™˜ê²½ ë°°í¬ íŠ¸ë¦¬ê±° ====================
  trigger-prod:
    name: ðŸš€ Trigger Prod Watchtower
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: ðŸ”‘ Setup SSH Key
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -z "${{ secrets.PROD_HOST }}" ]; then
            echo "âŒ PROD_HOST is not set!"
            exit 1
          fi

          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if ! head -1 ~/.ssh/id_rsa | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "âŒ SSH Key í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi

          ssh-keyscan -T 10 ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          cat > ~/.ssh/config << EOF
          Host ${{ secrets.PROD_HOST }}
            User ${{ secrets.PROD_SSH_USER || 'ubuntu' }}
            StrictHostKeyChecking accept-new
            UserKnownHostsFile ~/.ssh/known_hosts
            ConnectTimeout 60
            ServerAliveInterval 30
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config

      - name: ðŸ” Test SSH Connection
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ðŸ” Testing SSH connection..."
          ssh ${PROD_USER}@${PROD_HOST} "echo 'âœ… SSH connection successful'" || {
            echo "âŒ SSH connection failed!"
            exit 1
          }

      - name: ðŸ’¾ Backup Database
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ðŸ’¾ Creating database backup..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            cd ~/Hack-so42ety
            make db-backup-prod || echo "âš ï¸ Backup failed (may not exist yet)"
          ENDSSH

      - name: ðŸ“¢ Trigger Watchtower Update
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ðŸ“¢ Triggering Watchtower on Production server..."

          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            echo "ðŸ”„ Running Watchtower update..."
            docker exec moriai-watchtower-prod /watchtower --run-once || echo "âš ï¸ Watchtower not running yet"

            echo "â³ Waiting for update to complete (30s)..."
            sleep 30

            echo "ðŸ—„ï¸ Running database migrations..."
            cd ~/Hack-so42ety
            docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "âš ï¸ Migration failed or no changes"

            echo "ðŸ“Š Checking container status..."
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: ðŸ¥ Health Check
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          echo "ðŸ¥ Checking production service health..."
          sleep 10
          curl -f --max-time 10 http://${PROD_HOST}/api/health || echo "âš ï¸ Health check failed"

      - name: ðŸ“Š Check Service Status
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ðŸ“Š Checking service status..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            cd ~/Hack-so42ety
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: ðŸ“ Deployment Summary
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          echo "### ðŸŽ‰ Production Deployment Triggered!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: AWS EC2 (${PROD_HOST})" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Watchtower Auto-Update" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${PROD_HOST}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All services updated via Watchtower!" >> $GITHUB_STEP_SUMMARY
