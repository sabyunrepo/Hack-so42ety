name: üöÄ Deploy MoriAI

on:
  push:
    branches:
      - dev      # Dev ÌôòÍ≤Ω Î∞∞Ìè¨
      - main     # Production ÌôòÍ≤Ω Î∞∞Ìè¨

jobs:
  # ==================== Dev ÌôòÍ≤Ω Î∞∞Ìè¨ ====================
  deploy-dev:
    name: üîß Deploy to Dev Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH Private Key ÏÑ§Ï†ï
          echo "${{ secrets.DEV_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # SSH known_hosts ÏÑ§Ï†ï (ÌÉÄÏûÑÏïÑÏõÉ 10Ï¥à, Ïò§Î•ò Î¨¥Ïãú)
          echo "üîç Scanning host key for 14.36.34.122:23..."
          ssh-keyscan -p 23 -T 10 14.36.34.122 >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "‚ö†Ô∏è ssh-keyscan failed, but continuing..."
          }
          
          # SSH config ÏÑ§Ï†ï (StrictHostKeyChecking)
          echo "Host 14.36.34.122" >> ~/.ssh/config
          echo "  Port 23" >> ~/.ssh/config
          echo "  StrictHostKeyChecking accept-new" >> ~/.ssh/config
          echo "  UserKnownHostsFile ~/.ssh/known_hosts" >> ~/.ssh/config
          echo "  ConnectTimeout 10" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          echo "‚úÖ SSH setup completed"
      
      - name: üîç Test SSH Connection
        env:
          DEV_HOST: "14.36.34.122"
          DEV_PORT: "23"
          DEV_USER: "${{ secrets.DEV_SSH_USER || 'ubuntu' }}"
        run: |
          echo "üîç Testing SSH connection to ${DEV_USER}@${DEV_HOST}:${DEV_PORT}..."
          ssh -p ${DEV_PORT} -o ConnectTimeout=10 ${DEV_USER}@${DEV_HOST} "echo '‚úÖ SSH connection successful'" || {
            echo "‚ùå SSH connection failed!"
            exit 1
          }
      
      - name: üìä Deploy to Dev Server
        env:
          DEV_HOST: "14.36.34.122"
          DEV_PORT: "23"
          DEV_USER: "${{ secrets.DEV_SSH_USER || 'ubuntu' }}"
        run: |
          echo "üöÄ Deploying to Dev Server (14.36.34.122:23)..."
          
          ssh -p ${DEV_PORT} ${DEV_USER}@${DEV_HOST} << 'ENDSSH'
            set -e
            
            echo "üìÇ Navigating to project directory..."
            cd ~/Hack-so42ety || exit 1
            
            echo "üì• Pulling latest code (dev branch)..."
            git fetch origin dev
            git checkout dev
            git pull origin dev
            
            echo "üîÑ Stopping existing containers..."
            docker compose -f docker-compose.yml down || true
            
            echo "üèóÔ∏è Building images..."
            docker compose -f docker-compose.yml build --no-cache
            
            echo "üöÄ Starting services..."
            docker compose -f docker-compose.yml up -d
            
            echo "‚è≥ Waiting for services to start (10s)..."
            sleep 10
            
            echo "üóÑÔ∏è Running database migrations..."
            docker compose -f docker-compose.yml exec -T backend alembic upgrade head || echo "‚ö†Ô∏è Migration failed or no changes"
            
            echo "‚úÖ Dev deployment completed!"
          ENDSSH
      
      - name: üè• Health Check
        run: |
          echo "üè• Checking service health..."
          sleep 5
          curl -f http://14.36.34.122/api/health || echo "‚ö†Ô∏è Health check failed"
      
      - name: üìù Deployment Summary
        run: |
          echo "### üéâ Dev Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: 14.36.34.122:23" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://14.36.34.122" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ==================== Production ÌôòÍ≤Ω Î∞∞Ìè¨ ====================
  deploy-prod:
    name: üöÄ Deploy to Production (AWS EC2)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH Private Key ÏÑ§Ï†ï
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # PROD_HOST ÌôïÏù∏
          if [ -z "${{ secrets.PROD_HOST }}" ]; then
            echo "‚ùå PROD_HOST is not set!"
            exit 1
          fi
          
          # SSH known_hosts ÏÑ§Ï†ï (ÌÉÄÏûÑÏïÑÏõÉ 10Ï¥à, Ïò§Î•ò Î¨¥Ïãú)
          echo "üîç Scanning host key for ${{ secrets.PROD_HOST }}..."
          ssh-keyscan -T 10 ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "‚ö†Ô∏è ssh-keyscan failed, but continuing..."
          }
          
          # SSH config ÏÑ§Ï†ï (StrictHostKeyChecking)
          echo "Host ${{ secrets.PROD_HOST }}" >> ~/.ssh/config
          echo "  StrictHostKeyChecking accept-new" >> ~/.ssh/config
          echo "  UserKnownHostsFile ~/.ssh/known_hosts" >> ~/.ssh/config
          echo "  ConnectTimeout 10" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          echo "‚úÖ SSH setup completed"
      
      - name: üîç Test SSH Connection
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "üîç Testing SSH connection to ${PROD_USER}@${PROD_HOST}..."
          ssh -o ConnectTimeout=10 ${PROD_USER}@${PROD_HOST} "echo '‚úÖ SSH connection successful'" || {
            echo "‚ùå SSH connection failed!"
            exit 1
          }
      
      - name: üóÑÔ∏è Backup Database
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "üíæ Creating database backup..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            cd ~/Hack-so42ety
            make db-backup-prod || echo "‚ö†Ô∏è Backup failed (may not exist yet)"
          ENDSSH
      
      - name: üöÄ Deploy to Production
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "üöÄ Deploying to Production (AWS EC2)..."
          
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            set -e
            
            echo "üìÇ Navigating to project directory..."
            cd ~/Hack-so42ety || exit 1
            
            echo "üì• Pulling latest code (main branch)..."
            git fetch origin main
            git checkout main
            git pull origin main
            
            echo "üîÑ Stopping existing containers..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --profile production down || true
            
            echo "üèóÔ∏è Building production images..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build
            
            echo "üöÄ Starting production services..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --profile production up -d
            
            echo "‚è≥ Waiting for services to start (15s)..."
            sleep 15
            
            echo "üóÑÔ∏è Running database migrations..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "‚ö†Ô∏è Migration failed or no changes"
            
            echo "üßπ Cleaning up old images..."
            docker image prune -f || true
            
            echo "‚úÖ Production deployment completed!"
          ENDSSH
      
      - name: üè• Health Check
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          echo "üè• Checking production service health..."
          sleep 5
          curl -f http://${PROD_HOST}/api/health || echo "‚ö†Ô∏è Health check failed"
      
      - name: üìä Check Service Status
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "üìä Checking service status..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            cd ~/Hack-so42ety
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
          ENDSSH
      
      - name: üìù Deployment Summary
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          echo "### üéâ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: AWS EC2 (${PROD_HOST})" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${PROD_HOST}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All services are running!" >> $GITHUB_STEP_SUMMARY
