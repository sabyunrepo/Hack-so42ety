name: ğŸš€ Deploy MoriAI

on:
  push:
    branches:
      - dev      # Dev í™˜ê²½ ë°°í¬
      - main     # Production í™˜ê²½ ë°°í¬

jobs:
  # ==================== Dev í™˜ê²½ ë°°í¬ ====================
  deploy-dev:
    name: ğŸ”§ Deploy to Dev Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 23 14.36.34.122 >> ~/.ssh/known_hosts
      
      - name: ğŸ“Š Deploy to Dev Server
        env:
          DEV_HOST: "14.36.34.122"
          DEV_PORT: "23"
          DEV_USER: "${{ secrets.DEV_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ğŸš€ Deploying to Dev Server (14.36.34.122:23)..."
          
          ssh -p ${DEV_PORT} ${DEV_USER}@${DEV_HOST} << 'ENDSSH'
            set -e
            
            echo "ğŸ“‚ Navigating to project directory..."
            cd ~/Hack-so42ety || exit 1
            
            echo "ğŸ“¥ Pulling latest code (dev branch)..."
            git fetch origin dev
            git checkout dev
            git pull origin dev
            
            echo "ğŸ”„ Stopping existing containers..."
            docker compose -f docker-compose.yml down || true
            
            echo "ğŸ—ï¸ Building images..."
            docker compose -f docker-compose.yml build --no-cache
            
            echo "ğŸš€ Starting services..."
            docker compose -f docker-compose.yml up -d
            
            echo "â³ Waiting for services to start (10s)..."
            sleep 10
            
            echo "ğŸ—„ï¸ Running database migrations..."
            docker compose -f docker-compose.yml exec -T backend alembic upgrade head || echo "âš ï¸ Migration failed or no changes"
            
            echo "âœ… Dev deployment completed!"
          ENDSSH
      
      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Checking service health..."
          sleep 5
          curl -f http://14.36.34.122/api/health || echo "âš ï¸ Health check failed"
      
      - name: ğŸ“ Deployment Summary
        run: |
          echo "### ğŸ‰ Dev Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: 14.36.34.122:23" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://14.36.34.122" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ==================== Production í™˜ê²½ ë°°í¬ ====================
  deploy-prod:
    name: ğŸš€ Deploy to Production (AWS EC2)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ—„ï¸ Backup Database
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ğŸ’¾ Creating database backup..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            cd ~/Hack-so42ety
            make db-backup-prod || echo "âš ï¸ Backup failed (may not exist yet)"
          ENDSSH
      
      - name: ğŸš€ Deploy to Production
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ğŸš€ Deploying to Production (AWS EC2)..."
          
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            set -e
            
            echo "ğŸ“‚ Navigating to project directory..."
            cd ~/Hack-so42ety || exit 1
            
            echo "ğŸ“¥ Pulling latest code (main branch)..."
            git fetch origin main
            git checkout main
            git pull origin main
            
            echo "ğŸ”„ Stopping existing containers..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --profile production down || true
            
            echo "ğŸ—ï¸ Building production images..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build
            
            echo "ğŸš€ Starting production services..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --profile production up -d
            
            echo "â³ Waiting for services to start (15s)..."
            sleep 15
            
            echo "ğŸ—„ï¸ Running database migrations..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "âš ï¸ Migration failed or no changes"
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f || true
            
            echo "âœ… Production deployment completed!"
          ENDSSH
      
      - name: ğŸ¥ Health Check
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          echo "ğŸ¥ Checking production service health..."
          sleep 5
          curl -f http://${PROD_HOST}/api/health || echo "âš ï¸ Health check failed"
      
      - name: ğŸ“Š Check Service Status
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
          PROD_USER: "${{ secrets.PROD_SSH_USER || 'ubuntu' }}"
        run: |
          echo "ğŸ“Š Checking service status..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            cd ~/Hack-so42ety
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
          ENDSSH
      
      - name: ğŸ“ Deployment Summary
        env:
          PROD_HOST: "${{ secrets.PROD_HOST }}"
        run: |
          echo "### ğŸ‰ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: AWS EC2 (${PROD_HOST})" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${PROD_HOST}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All services are running!" >> $GITHUB_STEP_SUMMARY
